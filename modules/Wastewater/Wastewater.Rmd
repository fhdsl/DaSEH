---
title: "Wastewater analysis using R"
output:
  ioslides_presentation:
    css: ../../docs/styles.css
    widescreen: true
  beamer_presentation: default
---

```{r, echo = FALSE, include=FALSE}
library(knitr)
opts_chunk$set(fig.height = 4,
               fig.width = 7,
               comment = "")
library(readr)
suppressPackageStartupMessages(library(dplyr))
library(tidyverse)
install.packages('emoji', repos='http://cran.us.r-project.org', dependencies=TRUE)
library(emoji)
```


## Introduction
In this module, we will analyze a wastewater dataset from the CDC to investigate how COVID-19 viral levels change through time. 

We will learn ways to manipulate dates in R using the library **lubridate** (part of the Tidyverse package). 


## Recap: Dates and times in R
There are two most popular R classes used when working with dates and times: 

- `Date` class representing a calendar date and
- `POSIXct` class representing a calendar date with hours, minutes, seconds.

- A date-time object in R is a point on the timeline stored as the number of seconds since *January 1st, 1970, 00:00 UTC*. 
- This date is also called the **Unix epoch** and serves as a reference by computer systems to track and operate with time. 

## `lubridate` package:
- The lubridate package allows us to work with dates and times in a simple and efficient way. 
- In this module, we will learn to:
  - Input dates in different formats,
  - Perform basic operations with dates, and
  - Extract components of dates.


## `lubridate` first needs to understand the date format:

You tell lubridate how to "read" your character object.

```{r}
# YYYY-M-DD
a <- ymd("2024-9-20")

# DD/MM/YYYY
a <- dmy("20/09/2024")

# MM-DD-YY
a <- mdy("09-20-24")
```

## Extract the components of a date with   `lubridate`:
- Year, month, day of the month (`mday`): 
```{r}
a <- ymd_hms("2024-09-20 3:59:01")
year(a)
month(a)
mday(a)
```

## Extract the components of a date continued:
- Day of the year (`yday`), day of the week (`wday`), hour, minute and seconds
```{r}
yday(a)
wday(a)
hour(a)
minute(a)
second(a)
```
## Perform operations with dates:
```{r}
a <- ymd("2024-09-20")
b <- ymd("2025-07-15")
b - a
a - ymd("2024-08-20")
year(a) - 1989
```
## GUT CHECK:
What does the package `lubridate` allows us to do?

- Work with dates in R

- Produce time series data

- Plot time series data

## Data used:

We will use data reporting the level of SARS-CoV-2 (the virus responsible of COVID-19) viral particles in wastewater.

This data reports the level of SARS-CoV-2 at the state, regional and national level through time. According to this website, National, regional, and state/territory data represent the median values across all wastewater treatment plants in the respective area.

You can read about the data and how it was collected here:
https://www.cdc.gov/nwss/rv/COVID19-statetrend.html

## Download the data{.codesmall}
We will use the data located here:
```{r, message = FALSE}
dat <- read_csv("http://daseh.org/data/wastewater_COVID-19_State_and_Territory_Trends.csv")
```
<!-- <div style="font-size:18pt"> https://www.cdc.gov/wcms/vizdata/NCEZID_DIDRI/SC2/nwsssc2stateactivitylevelDL.csv -->
<!-- </div> -->
<!-- ```{r, message = FALSE} -->
<!-- dat <- read_csv("https://www.cdc.gov/wcms/vizdata/NCEZID_DIDRI/SC2/nwsssc2stateactivitylevelDL.csv") -->
<!-- head(dat) -->
<!-- ``` -->

<!-- ```{r, message = FALSE}
dat <- read_csv("https://daseh.org/datadata/wastewater_COVID-19_State_and_Territory_Trends.csv")
head(dat)
```
--> 





## Clean up the data a little bit:{.codesmall} 
- Some column names contain `/` and spaces, which are not standard form. We will change them so it is easier to work with them.To do so, we use the function `clean_names` part of `janitor` package. Look at the column names of the old dataset (called `dat`) and the column names of the new dataset (called `dat1`), the new names are all in lower case with underscores between words.


```{r}
dat1 <- dat |> janitor::clean_names() 
colnames(dat)
colnames(dat1)
```
## Mission: Understand the trends of COVID-19 disease through time in different parts of the United States (US).

Let's imagine we want to understand how SARS-CoV-2 infections (and hence COVID-19 disease) change through time in three different parts of the US: the East coast, the West coast, and the Midwest. We want to obtain plots that should look like this:

```{r, echo=FALSE, results='hide',message=FALSE}
library(janitor)
temp = dat |> janitor::clean_names() |> filter(state_territory %in% c("California", 
                                                                     "Colorado", 
                                                                     "Maine"))
```

```{r, fig.align='center', echo=FALSE}
ggplot(data=temp, aes(x = week_ending_date, y=state_territory_wval, 
                color=state_territory)) + geom_line(linewidth=0.8) + 
  theme(text = element_text(size = 18))
```

## Clean up the data (continued){.codesmall} 
- We will not be using the columns `Coverage` and `date_updated` so we will remove them from our data frame.
- We will conduct our analysis using all the results available, so that we will remove the rows with results at 1 year or every 6 months.
```{r}
dat2 <- dat1 |> select(!c(coverage, date_updated)) |> filter(data_collection_period == "All Results")
head(dat2)
```


## Select 3 states to look at:{.codesmall} 
- We will select three states in the US in three different parts (East, Center, West) to look at their wastewater data:  South Carolina, Nebraska, Washington. 

```{r}
df <- dat2 |> filter(state_territory %in% c('South Carolina', 'Nebraska', 'Washington'))
head(df)
```


## Look at the data!{.codesmall}
We will plot the data using ggplot:
```{r, fig.align='center'}
ggplot(data=df, aes(x = week_ending_date, y=state_territory_wval, 
                color=state_territory)) + geom_line(linewidth=0.8) + 
  theme(text = element_text(size = 18))

```


## Split the plots to see the patterns more clearly:{.codesmall}

```{r, fig.align='center'}
ggplot(data=df, aes(x = week_ending_date, y=state_territory_wval, color=state_territory)) + 
  geom_line(linewidth=0.8) + theme(text = element_text(size = 18)) + facet_grid(state_territory~.)

```


## What can we say about this data?
- Seasonality pattern for each state.

- Looks like the peaks of the 2023-2024 winter season occurred at slightly different times in each state.

- Most of the big waves happen in winter time, but all three states had a summer outbreak in 2024.


## Zoom in the data!
- Now, we want to investigate how big was the summer outbreak in each state in 2024.

- We use `lubridate` to select only the data from year 2024:

## Quick quiz
Do you remember how to extract the year from a date called `mydate`?

1. `year(mydate)`

2. `extract(year, mydate)`

3. `mydate.year()`


## Extract the data for year 2024:

```{r}
df2024 <- df |> filter(year(week_ending_date) == 2024)
head(df2024)
```


## Obtain the peak viral level in each state.{.codesmall}

First, we need to group the data by state, we use the function`group_by` from `dplyr` to do it:

```{r, eval=FALSE} 
maxRows <- df2024  |> group_by(state_territory) |> 
```

then retrieve the rows with the peak level:
```{r, eval=FALSE} 
maxRows <- df2024  |> group_by(state_territory) |> ???
```
How do we do this?

## Quick quiz
Do you remember what function to use to obtain the peak level?

1. `max(dat)`

2. `min(dat)`

3. `unique(dat)`


## Obtain the peak viral level in each state.{.codesmall}

To do this, we need to group the data by state and retrieve the rows with the maximum level:

```{r}
maxRows <- df2024  |> group_by(state_territory) |> 
          filter(state_territory_wval == max(state_territory_wval, na.rm=TRUE)) 
maxRows
```



## Extract the peak wastewater levels for each state:{.codesmall}
We will compute the date of the summer peak in each state:
```{r}
Nebraska_peak <- maxRows %>% filter(state_territory=="Nebraska") %>% 
                             pull(week_ending_date)
South_Carolina_peak <- maxRows %>% filter(state_territory=="South Carolina") %>% 
                                   pull(week_ending_date)
Washington_peak <- maxRows %>% filter(state_territory=="Washington") %>% 
                               pull(week_ending_date)
Nebraska_peak
South_Carolina_peak
Washington_peak
```

## Compute the number of days between the peak wastewater levels for each state during the summer wave:{.codesmall}

- Difference between South Carolina and Nebraska
```{r}
Nebraska_peak - South_Carolina_peak
```

- Difference between South Carolina and Washington

```{r}
South_Carolina_peak - Washington_peak
```

- Difference between Nebraska and Washington
```{r}
Nebraska_peak - Washington_peak
```

## Summer wave:

- From this data, we can see that South Carolina and Washington had a summer wave that peaked 21 days apart. 

- However, the maximum calculated for Nebraska corresponds to the winter wave, not to the summer wave.

```{r, echo = FALSE, fig.align='center', out.width= "45%"}
knitr::include_graphics("images/confused_emoji.jpeg")
```

## Let's look again at the plot, but this time restricted to the year 2024:{.codesmall}

```{r, fig.align='center'}
ggplot(data=df2024, aes(x = week_ending_date, y=state_territory_wval, color=state_territory)) + 
  geom_line(linewidth=0.8) + theme(text = element_text(size = 18)) + facet_grid(state_territory~.)

```


## Summer wave continued:

How can we obtain the day that the wastewater measurement reached the maximum level for Nebraska in the summer?

## Summer wave continued:{.codesmall}

We will further zoom our attention to the summer months and modify the code to look at the data for the months of June, July and August 2024:

```{r}
maxRows <- df2024 |> filter(month(week_ending_date) %in% c(06, 07, 08)) |>
                      group_by(state_territory) |>
                      filter(state_territory_wval == max(state_territory_wval, na.rm=TRUE))
                                                          
maxRows
```

## Number of days between summer peaks
Now we can compute the number of days between the peak waste water levels for each state during the summer wave:

```{r}
Nebraska_peak <- maxRows %>% filter(state_territory=="Nebraska") %>% pull(week_ending_date)
South_Carolina_peak <- maxRows %>% filter(state_territory=="South Carolina") %>% pull(week_ending_date)
Washington_peak <- maxRows %>% filter(state_territory=="Washington") %>% pull(week_ending_date)
```
- Difference between South Carolina and Nebraska
```{r}
Nebraska_peak - South_Carolina_peak
```

- Difference between South Carolina and Washington

```{r}
South_Carolina_peak - Washington_peak
```

## Conclusion

- South Carolina and Washington had a summer wave that peaked 21 days apart.

- Nebraska and Washington had a summer wave that peaked 28 days apart. 

- Nebraska and South Carolina had a summer wave that peaked one week apart.
