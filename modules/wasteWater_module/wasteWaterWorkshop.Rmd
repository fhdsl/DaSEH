---
title: "Wastewater analysis using R"
output:
  ioslides_presentation:
    css: ../../docs/styles.css
    widescreen: true
  beamer_presentation: default
---

```{r, echo = FALSE, include=FALSE}
library(knitr)
opts_chunk$set(comment = "")
library(readr)
suppressPackageStartupMessages(library(dplyr))
library(tidyverse)
install.packages('emoji', repos='http://cran.us.r-project.org', dependencies=TRUE)
library(emoji)
```


## Introduction
In this module, we will analyze a wastewater dataset from the CDC to investigate how COVID-19 viral levels change through time. 

We will learn ways to manipulate dates in R using the library **lubridate** (part of the Tidyverse package). 


## Recap: Dates and times in R
There are two most popular R classes used when working with dates and times: 

- `Date` class representing a calendar date and
- `POSIXct` class representing a calendar date with hours, minutes, seconds.

- A date-time object in R is a point on the timeline stored as the number of seconds since *January 1st, 1970, 00:00 UTC*. 
- This date is also called the **Unix epoch** and serves as a reference by computer systems to track and operate with time. 

## `lubridate` package:
- The lubridate package allows us to work with dates and times in a simple and efficient way. 
- In this module, we will learn to:
  - Input dates in different formats,
  - Perform basic operations with dates, and
  - Extract components of dates.


## `lubridate` is very flexible for inputting dates in different formats: 
- YYYY\-MM\-DD:

```{r}
a <- ymd("2024-09-20")
```

- DD-MM-YYYY:
```{r}
a <- dmy("20-09-2024")
```

- MM-DD-YY
```{r}
a <- dmy("20-09-2024")
```



## Extract the components of a date with   `lubridate`:
- Year, month, day of the month (mday): 
```{r}
a <- ymd_hms("2024-09-20 3:59:01")
myyear = year(a)
mymonth = month(a)
myday = mday(a)
```

## Extract the components of a date continued:
- Day of the year (yday), day of the week (wday), hour, minute and seconds
```{r}
yday(a)
wday(a)
hour(a)
minute(a)
second(a)
```
## Perform operations with dates:
```{r}
a <- ymd("2024-09-20")
b <- ymd("2025-07-15")
b - a
a - ymd("2024-08-20")
myyear - 1989
```
## GUT CHECK:
What does the package `lubridate` allows us to do?

- Work with dates in R

- Produce time series data

- Plot time series data

## Data used:

We will use data reporting the level of SARS-CoV-2 (the virus responsible of COVID-19) viral particles in wastewater.

This data reports the level of SARS-CoV-2 at the state, regional and national level through time. According to this website, National, regional, and state/territory data represent the median values across all wastewater treatment plants in the respective area.

You can read about the data and how it was collected here:
https://www.cdc.gov/nwss/rv/COVID19-statetrend.html

## Download the data{.codesmall}
We will use the data located here:

<div style="font-size:18pt"> https://www.cdc.gov/wcms/vizdata/NCEZID_DIDRI/SC2/nwsssc2stateactivitylevelDL.csv
</div>


```{r, message = FALSE}
dat = read_csv("https://www.cdc.gov/wcms/vizdata/NCEZID_DIDRI/SC2/nwsssc2stateactivitylevelDL.csv")
head(dat)
```


## Mission: Understand the trends of COVID-19 disease through time in different parts of the United States (US).
Let's imagine we want to understand how SARS-CoV-2 infections (and hence COVID-19 disease) change through time in three different parts of the US: the East coast, the West coast, and the Midwest. We want to obtain plots that should look like this:


## Clean up the data a little bit:
- Some column names contain `/` and spaces, which are not standard form. We will change them so it is easier to work with them.To do so, we use the function `rename` (part of dplyr).
- We will not be using the columns `Coverage` and `date_updated` so we will remove them from our data frame.

```{r}
mydat = dat |> rename(State_Territory_WVAL = `State/Territory_WVAL`,
                    State_Territory = `State/Territory`,
                    ) |> select(!c(Coverage, date_updated)) 
```

## Clean up the data (continued)
- We will conduct our analysis using all the results available, so that we will remove the rows with results at 1 year or every 6 months.
```{r}
mydat2 = mydat |> filter(Data_Collection_Period == "All Results")
```


## Select 3 states to look at:{.codesmall} 
- We will select three states in the US in three different parts (East, Center, West) to look at their wastewater data:  South Carolina, Nebraska, Washington. 

```{r}
df <- mydat2 |> filter(State_Territory %in% c('South Carolina', 'Nebraska', 'Washington'))
head(df)
```


## Look at the data!{.codesmall}
We will plot the data using ggplot:
```{r, fig.align='center'}
ggplot(data=df, aes(x = Week_Ending_Date, y=State_Territory_WVAL, 
                color=State_Territory)) + geom_line(linewidth=0.8) + 
  theme(text = element_text(size = 18))

```


## Split the plots to see the patterns more clearly:{.codesmall}

```{r, fig.align='center'}
ggplot(data=df, aes(x = Week_Ending_Date, y=State_Territory_WVAL, color=State_Territory)) + 
  geom_line(linewidth=0.8) + theme(text = element_text(size = 18)) + facet_grid(State_Territory~.)

```


## What can we say about this data:
- Seasonality pattern for each state.

- Most of the big waves happen in winter time, but all three states had a summer outbreak in 2024.

- Looks like the peaks of the 2023-2024 winter season occurred at slightly different times in each state. 

## Zoom in the data!
- Now, we want to investigate how big was the summer outbreak in each state in 2024.

- We use lubridate to select only the data from year 2024:

## Quick quizz
Do you remember how to extract the year from a date called mydate?

1. year(mydate)

2. extract(year, mydate)

3. mydate.year()


## Extract the data for year 2024:

```{r}
df2024 <- df |> filter(year(Week_Ending_Date) == 2024)
head(df2024)
```


## Group the data by state and retrieve the rows with the maximum level in each state:{.codesmall}

```{r}
maxRows <- df2024  |> group_by(State_Territory) |> 
          filter(State_Territory_WVAL == max(State_Territory_WVAL, na.rm=TRUE)) 
maxRows
```

## Compute the number of days between the peak wastewater levels for each state during the summer wave:

- Difference between South Carolina and Nebraska
```{r}
maxRows$Week_Ending_Date[1] - maxRows$Week_Ending_Date[2]
```

- Difference between South Carolina and Washington

```{r}
maxRows$Week_Ending_Date[1] - maxRows$Week_Ending_Date[3]
```

- Difference between Nebraska and Washington
```{r}
maxRows$Week_Ending_Date[2] - maxRows$Week_Ending_Date[3]
```

## Summer wave:

- From this data, we can see that South Carolina and Washington had a summer wave that peaked 21 days apart. 

- However, the maximum for Nebraska corresponds to the winter wave, not to the summer wave.

```{r, echo = FALSE, fig.align='center', out.width= "45%"}
knitr::include_graphics("images/confused_emoji.jpeg")
```

## Let's look again at the plot, but this time restricted to the year 2024:

```{r, fig.align='center'}
ggplot(data=df2024, aes(x = Week_Ending_Date, y=State_Territory_WVAL, color=State_Territory)) + 
  geom_line(linewidth=0.8) + theme(text = element_text(size = 18)) + facet_grid(State_Territory~.)

```


## Summer wave continued:

How can we obtain the day that the wastewater measurement reached the maximum level for Nebraska in the summer?

## Summer wave continued:{.codesmall}

We will further restrict our attention to the summer months and modify the code as follows:

```{r}
maxRows <- df2024 |> filter(month(Week_Ending_Date) %in% c(06, 07, 08)) |>
                      group_by(State_Territory) |>
                      filter(State_Territory_WVAL == max(State_Territory_WVAL, na.rm=TRUE))
                                                          
maxRows
```

## Number of days between summer peaks
Now we can compute the number of days between the peak waste water levels for each state during the summer wave:

- Difference between South Carolina and Nebraska
```{r}
maxRows$Week_Ending_Date[1] - maxRows$Week_Ending_Date[2]
```

- Difference between South Carolina and Washington

```{r}
maxRows$Week_Ending_Date[1] - maxRows$Week_Ending_Date[3]
```

- Difference between Nebraska and Washington
```{r}
maxRows$Week_Ending_Date[2] - maxRows$Week_Ending_Date[3]
```

## Conclusion

- South Carolina and Washington had a summer wave that peaked 21 days apart.

- Nebraska and Washington had a summer wave that peaked 28 days apart. 

- Nebraska and South Carolina had a summer wave that peaked one week apart.
